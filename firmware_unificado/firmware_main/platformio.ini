; PlatformIO Project Configuration File
; Neurona Off Road Telemetry - Firmware Unificado
;
; Soporta múltiples fuentes de datos: CAN (MoTeC), OBD2 (ELM327), GPS, IMU
; Arquitectura modular con TelemetryBus compartido
;
; Build: pio run
; Upload: pio run -t upload
; Monitor: pio device monitor

[platformio]
src_dir = .

[env:esp32dev]
platform = espressif32@6.5.0
board = esp32dev
framework = arduino

; Velocidad de monitor serial
monitor_speed = 115200

; Velocidad de upload
upload_speed = 921600

; Puerto Serial (COM3 según usuario)
upload_port = COM3
monitor_port = COM3

; Particiones con espacio para OTA y LittleFS
board_build.partitions = default.csv

; Filesystem
board_build.filesystem = littlefs

; Build flags - Optimización de memoria
; Build flags - Optimización de memoria
build_flags =
    -DCORE_DEBUG_LEVEL=0                    ; Reducir debug level para ahorrar memoria
    -DCONFIG_ASYNC_TCP_RUNNING_CORE=1
    -DCONFIG_ASYNC_TCP_USE_WDT=1
    ; Habilitar watchdog
    -DCONFIG_ESP_TASK_WDT_TIMEOUT_S=10
    ; Optimizaciones de memoria
    -DCONFIG_LWIP_MAX_SOCKETS=8             ; Reducir sockets máximos
    -DCONFIG_LWIP_TCP_MAXRTX=6              ; Reducir reintentos TCP
    -DCONFIG_LWIP_TCP_MSS=1024              ; Reducir MSS TCP
    -DARDUINOJSON_USE_LONG_LONG=0           ; Deshabilitar soporte para long long
    -DARDUINOJSON_ENABLE_PROGMEM=1          ; Habilitar PROGMEM para strings
    -DARDUINOJSON_USE_DOUBLE=0              ; Deshabilitar doubles (usar floats)
    -Wl,--gc-sections                       ; Eliminar secciones no usadas
    -ffunction-sections
    -fdata-sections
    -Os                                     ; Optimización por tamaño
    -mfix-esp32-psram-cache-issue

; Librerías del proyecto
lib_deps =
    ; WiFi y networking
    bblanchon/ArduinoJson@^7.0.0
    knolleary/PubSubClient@^2.8
    me-no-dev/AsyncTCP@^1.1.1
    me-no-dev/ESPAsyncWebServer@^1.2.3
    
    ; CAN Bus
    coryjfowler/mcp_can@^1.5.0
    
    ; GPS
    mikalhart/TinyGPSPlus@^1.0.3
    
    ; IMU MPU6050
    adafruit/Adafruit MPU6050@^2.2.4
    adafruit/Adafruit Unified Sensor@^1.1.9
    
    ; OBD2 (para modo directo)
    powerbroker2/ELMDuino@^3.4.0
    
    ; Almacenamiento
    ; LittleFS incluido en esp32 core

; Ajustes de memoria para FreeRTOS
board_build.f_cpu = 240000000L

; Optimizaciones de compilación
build_unflags = -std=gnu++11

[env:esp32dev_debug]
extends = env:esp32dev
build_type = debug
build_flags =
    ${env:esp32dev.build_flags}
    -DDEBUG_MODE=1
    -Og  ; Optimización para debugging

[env:esp32dev_release]
extends = env:esp32dev
build_type = release
build_flags =
    ${env:esp32dev.build_flags}
    -DNDEBUG
    -Os  ; Optimización por tamaño
    ; -flto  ; Link Time Optimization (DESHABILITADO: causa "plugin needed to handle lto object" y fallas de link)
